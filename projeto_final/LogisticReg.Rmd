---
title: "Trabalho Final - Regressao Logistica"
output: html_notebook
---

Carregando os dados e criando as categorias de drogas pré definidas pelo grupo:

```{r}
data <- readxl::read_xlsx("drug_consumption_dataset.xlsx")
head(data)

data <- transform(data, light_drugs = ifelse(
  ((Alcohol == "Never Used" | Alcohol == "Used over a Decade Ago") &
     (Caff == "Never Used" | Caff == "Used over a Decade Ago") &
     (Nicotine == "Never Used" | Nicotine == "Used over a Decade Ago") &
     (Choc == "Never Used" | Choc == "Used over a Decade Ago")), "No", "Yes"))

data <- transform(data, medium_drugs = ifelse(
  ((Cokes == "Never Used" | Cokes == "Used over a Decade Ago") &
     (Ecstasy == "Never Used" | Ecstasy == "Used over a Decade Ago") &
     (LSD == "Never Used" | LSD == "Used over a Decade Ago") &
     (Mushrooms == "Never Used" | Mushrooms == "Used over a Decade Ago")), "No", "Yes"))

data <- transform(data, heavy_drugs = ifelse(
  ((Amphet == "Never Used" | Amphet == "Used over a Decade Ago") &
     (Crack == "Never Used" | Crack == "Used over a Decade Ago") &
     (Heroin == "Never Used" | Heroin == "Used over a Decade Ago") &
     (VSA == "Never Used" | VSA == "Used over a Decade Ago")), "No", "Yes"))

#teste

head(data)
table(data$light_drugs)
table(data$medium_drugs)
table(data$heavy_drugs)

```


```{r}
summary(data)
```

Vamos começar com medium drugs que é o que tem praticamente meio a meio de respostas:

```{r}
table(data$Age)
table(data$Country)
```


```{r}
install.packages("ggplot2")
library(ggplot2)
country_filter_data <- data[data$Country %in% c("UK", "USA", "Canada"),]
ggplot(country_filter_data, aes(x = medium_drugs, y = NScore, fill = medium_drugs)) +   geom_boxplot(size = .75) +   facet_grid(Country ~ Gender, margins = FALSE) +   theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
```

Primeira tentativa de ajuste de modelo na proportional odds logistic regression usando **polr** do pacote **MASS**. Teste apenas com LSD pois polr funciona com 3 fatores para mais. Utilizando os 7.

```{r}
install.packages("MASS")
library(MASS)
data$LSD <- as.factor(data$LSD)
model_fit <- polr(LSD~Ethnicity+Education+Country+Age+Gender+NScore+EScore+OScore+AScore+CScore+Impulsive+SS+light_drugs, data = data, Hess = TRUE)
summary(model_fit)

```

```{r}
summary_table <- coef(summary(model_fit))
pval <- pnorm(abs(summary_table[, "t value"]),lower.tail = FALSE)* 2
summary_table <- cbind(summary_table, "p value" = round(pval,3))
summary_table
```

Agrupando por categoria de drogas pré definidas pelo grupo agora com 3 fatores. Começando por medium drugs:

```{r}

data <- transform(data, medium_drugs = ifelse(
  ((Cokes == "Never Used") &
     (Ecstasy == "Never Used") &
     (LSD == "Never Used") &
     (Mushrooms == "Never Used")), "Never", 
  ifelse(
    ((Cokes == "Used in Last Decade" | Cokes == "Used over a Decade Ago") &
     (Ecstasy == "Used in Last Decade" | Ecstasy == "Used over a Decade Ago") &
     (LSD == "Used in Last Decade" | LSD == "Used over a Decade Ago") &
     (Mushrooms == "Used in Last Decade" | Mushrooms == "Used over a Decade Ago")), "Possibly", "Yes")
  ))

data$medium_drugs <- as.factor(data$medium_drugs)

```


Ajuste do modelo para a categoria drogas intermediarias:

```{r}
model_fit <- polr(medium_drugs~Ethnicity+Education+Country+Age+Gender+NScore+EScore+OScore+AScore+CScore+Impulsive+SS+light_drugs, data = data, Hess = TRUE)
summary(model_fit)
```


```{r}
summary_table <- coef(summary(model_fit))
pval <- pnorm(abs(summary_table[, "t value"]),lower.tail = FALSE)* 2
summary_table <- cbind(summary_table, "p value" = round(pval,3))
summary_table
```


Testando o modelo:

```{r}
new_data <- data.frame("Age"= "25-34","Education"="Masters degree","Country"="Other","Gender"="Female","NScore"=30, "EScore"=55, "OScore"=50, "AScore"=60, "CScore"=60, "Impulsive"= 0.19268, "SS"= -0.84637, light_drugs="Yes", "Ethnicity"="White")

round(predict(model_fit,new_data,type = "p"), 3)

```

Nosso modelo previu que a pessoa com as caracteristicas acima seria um nao usuario de drogas medias. 


Agora vamos fazer o modelo com treinamento e teste, e avaliar a taxa de acerto:

Primeiro, dividir os dados:
```{r}
# Funcao para dividir dados aleatoriamente em treinamento e teste #
split_data = function(data, train_perc){
  train_size <- floor(train_perc * nrow(data))
  train_index <- sample(seq_len(nrow(data)), size = train_size)
  train <- data[train_index, ]
  test <- data[-train_index, ]
  return(list("train" = train,
              "test" = test))
}

set.seed(205650)
splitted_data <- split_data(data, 0.85)
train <- splitted_data$train
test <- splitted_data$test

```

Rodar o modelo para o set de treinamento:
```{r}
model_fit <- polr(medium_drugs~Ethnicity+Education+Country+Age+Gender+NScore+EScore+OScore+AScore+CScore+Impulsive+SS+light_drugs, data = train, Hess = TRUE)
```

Fazer a predicao com o modelo de teste: 

```{r}
predictions <- round(predict(model_fit,test,type = "p"), 3)
predictions <- as.data.frame(predictions)
library(data.table)
setDT(predictions, keep.rownames = "ID")[]
```

Testes de comparacao:

```{r}
predictions_ids = as.numeric(predictions$ID)
total = length(test$ID)
correct = 0
for (i in predictions_ids) {
  predicted = predictions[predictions$ID == toString(as.integer(i))]
  predicted <- predicted[,-1]
  predicted = colnames(predicted)[max.col(predicted[1, ], ties.method = "first")]
  if(predicted == test[toString(i),"medium_drugs"]) {
    correct = correct + 1
  }
}
print("Taxa de acerto:")
correct/total
```


#TODO

- Modificar o banco para usar variaveis dummy
- Remover Imp e SS

Usando glm:

```{r}
head(data)
```


```{r}
modLog = glm(medium_drugs ~Gender+Education+NScore+EScore+OScore+AScore+CScore, data=train, family="binomial")

summary(modLog)


```

Variaveis significativas: EScore, OScore, AScore, CScore


```{r}
modLog = glm(medium_drugs ~OScore+AScore+CScore, data=train, family="binomial")

summary(modLog)

```

```{r}
pred = predict(modLog, newdata=test, type="response")
table(test$medium_drugs, as.numeric(pred >= 0.5))

```
Accuracy:
```{r}
(84 + 115)/ nrow(test)
```

Sensitivity: 
```{r}
115/(115+31)
```

Specificity:
```{r}
84 / (84+53)
```
```{r}
table(test$medium_drugs)

```
```{r}
137/(137+146)
```

```{r}
threshold=0.2
predicted_values<-ifelse(predict(modLog,type="response")>threshold,1,0)
actual_values<- modLog$y
conf_matrix<-table(predicted_values,actual_values)
conf_matrix
```

