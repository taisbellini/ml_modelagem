---
title: "Trabalho Final - Regressao Logistica"
output: html_notebook
---

## Ecstasy

-> primeiro rodar os chunks do Compilado

Colocando os dados em variaveis especificas para o experimento:

```{r}
dataLogEcstasy <- data
xtabs(~ ecstasy_user + CScore, data = dataLogEcstasy)
xtabs(~ ecstasy_user + NScore, data = dataLogEcstasy)
xtabs(~ ecstasy_user + OScore, data = dataLogEcstasy)
xtabs(~ ecstasy_user + AScore, data = dataLogEcstasy)
xtabs(~ ecstasy_user + EScore, data = dataLogEcstasy)
xtabs(~ ecstasy_user + Gender, data = dataLogEcstasy)
xtabs(~ ecstasy_user + Age, data = dataLogEcstasy)
xtabs(~ ecstasy_user + Education, data = dataLogEcstasy)

table(dataLogEcstasy$ecstasy_user)
```

Separar em treino e teste usando o create data partition que garante distribuicoes similares:

```{r}
set.seed(205650)
indexes <- createDataPartition(dataLogEcstasy$ecstasy_user, p = 0.85, list = FALSE)
trainLogEcstasy = dataLogEcstasy[indexes, ]
testLogEcstasy = dataLogEcstasy[-indexes, ]
```

Rodando o glm full model:
```{r}
trainLogEcstasy <- subset(trainLogEcstasy, select = -c(ID, alcohol_user, stimulating_user, cannabis_user))


fullModLogEcstasy <- glm(ecstasy_user ~ ., data=trainLogEcstasy, family = "binomial")
fullModLogEcstasy

```

```{r}
predFullEcstasy <- ifelse(predict(fullModLogEcstasy, newdata = testLogEcstasy) >= 0.5, 1, 0)
confusionMatrix(table(predFullEcstasy, testLogEcstasy$ecstasy_user))
```


Ponto de corte em 0.8:
```{r}
predFullEcstasy08 <- ifelse(predict(fullModLogEcstasy, newdata = testLogEcstasy) >= 0.8, 1, 0)
confusionMatrix(table(predFullEcstasy08, testLogEcstasy$ecstasy_user))

```

```{r}
predFullEcstasy03 <- ifelse(predict(fullModLogEcstasy, newdata = testLogEcstasy) >= 0.3, 1, 0)
confusionMatrix(table(predFullEcstasy03, testLogEcstasy$ecstasy_user))

```


Rodando com stepAIC:
```{r}
stepEcstasy <- stepAIC(fullModLogEcstasy, direction = "backward")
stepEcstasy$anova

```

Resumo
```{r}
summary(stepEcstasy)
```


```{r}
predStepEcstasy <- ifelse(predict(stepEcstasy, newdata = testLogEcstasy) >= 0.75, 1, 0)
confusionMatrix(table(predStepEcstasy, testLogEcstasy$ecstasy_user))

```


```{r}
library(ggplot2)
## now we can plot the data
predicted.data <- data.frame(
  prob.user=stepEcstasy$fitted.values,
  user=trainLogEcstasy$ecstasy_user)
 
predicted.data <- predicted.data[
  order(predicted.data$prob.user, decreasing=FALSE),]
predicted.data$rank <- 1:nrow(predicted.data)
 
ggplot(data=predicted.data, aes(x=rank, y=prob.user)) +
  geom_point(aes(color=user), alpha=1, shape=4, stroke=2) +
  xlab("Index") +
  ylab("Predicted probability of being a Ecstasy drug user")
```

Importancia das variaveis: 
```{r}
variableImportance <- varImp(fullModLogEcstasy , scale = FALSE)
variableImportance
```

Calculando o odds ratio:
Quando é < 1 a interpretação fica 

OScoreVeryLow: 0.54 -> Pessoas com esse score baixo tem 46% de chance menor de ser usuario quando comparado as demais classes deste escore.

Ethnicity dar uma olhada na distribuicao para explicar.

OScoreHigh 1.31 -> a chance de ser usuario eh 1.31x maior de ser usuario do que as demais categorias.  

```{r}
stepEcstasy
round(exp(coef(stepEcstasy)), 2)
```



## Referencias
http://www.sthda.com/english/articles/36-classification-methods-essentials/150-stepwise-logistic-regression-essentials-in-r/
http://www.utstat.toronto.edu/~brunner/oldclass/appliedf11/handouts/2101f11StepwiseLogisticR.pdf
https://machinelearningmastery.com/how-to-estimate-model-accuracy-in-r-using-the-caret-package/